#!/bin/bash

TARGET=$1
TMP=$2
DIR="$( cd "$( dirname "$0" )" && pwd )"

ZNC_VERSION="1.6.0"
ZNC="znc-$ZNC_VERSION"
ZNC_GZ="$ZNC.tar.gz"
ZNC_URL="http://znc.in/releases/$ZNC_GZ"

echo "-----> Installing ngrok and runner"
pushd $DIR
  cp -R ../files/run_znc.sh $TARGET/run_znc.sh
  cp -R ../files/ngrok $TARGET/ngrok
popd

mkdir -p /app
mkdir -p $TMP

echo `pwd`
echo "-----> downloading and compile znc"
  
pushd $TMP
  curl -O $ZNC_URL
  tar zxvf $ZNC_GZ
  
  pushd $ZNC
    ./configure --prefix="/app/znc"
    make
    make install
  popd
popd

cp -R /app/znc/ $TARGET/

echo "-----> Relocating znc config to proper folder"
mkdir -p $TARGET/.znc/configs
cp $TARGET/znc.conf $TARGET/.znc/configs/znc.conf
rm $TARGET/znc.conf

echo "-----> Setting up Procfile"
pushd $DIR 
  cp ../Procfile $TARGET/Procfile
popd
